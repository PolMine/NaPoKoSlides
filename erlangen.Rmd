---
title: "Freiheit - Gleichheit - Intersubjektivität"
subtitle: "Die Annotation von Kookkurrenz-Graphen mit 'gradget'-htmlwidgets"
author: "Andreas Blaette"
date: "4 12 2018"
output:
  ioslides_presentation:
    css: css/stylesheet.css
    logo: img/polmine.png
    widescreen: no
    incremental: true
  slidy_presentation: default
editor_options:
  chunk_output_type: console
---

```{r loading_libraries, echo = FALSE, message = FALSE}
library(polmineR)
library(data.table)
library(magrittr)
library(gradget)
library(igraph)
library(DiagrammeR)
```

```{r use_migparl, echo = FALSE, message = FALSE}
use("MigParl")
```


## Inhaltliches Interesse {.build}

- Grundfrage: Wandel des Parlamentarismus durch Einzug der AfD?

- (deskriptive) Vorfragen: Welche Deutungsmuster prägen die parlamentarischen Reden von Abgeordneten der AfD?

- 

- Folgefragen: Diffusion / Übernahme solcher Deutungsmuster durch andere Parteien? Varianz zwischen Landesparlamenten? Etc.

- vgl. DFG-Projekt (2019-2021): "Die populistische Herausforderung im Parlament" (mit Christian Strecker, Marcel Lewandowsky, Jochen Müller)


## Methodisches Interesse I 

```{r old_vis, echo = FALSE, fig.width = 5, fig.height = 5}
img_path <- "/Users/blaette/Nextcloud/Org/Termine/2018-12-04_Erlangen/kollakogramm_old.jpg"
  knitr::include_graphics(path = img_path, auto_pdf = getOption("knitr.graphics.auto_pdf", FALSE), dpi = 300)
```


## Methodisches Interesse II

- Ziel: Valide und reliable Ergebnisse gerade auch durch eHumanities, aber:
  - Grenzen der Topic-Modelle 
  - Grenzen der (reinen) Kollokationsanalysen

- Codier- bzw. Annotationstraditionen:
  - quantifizierende Inhaltsanalyse
  - qualitative Inhaltsanalyse
  - Annotation zur Gewinnung von Trainingsdaten für statistisches Lernen

- Interaktive Annotation von Graphen als neue Spielform der Annotation?


## Zum PolMine-Projekt

- Daten (GermaParl | GermaParlRegio | MigParl | ...)

- Code (polmineR | RcppCWB | cwbtools | bignlp | trickypdf | frappp | annolite | gradget)

- Projekte
  - Arenen der Interessenvermittlung (MERCUR)
  - Plenarprotokolle als öffentliche Sprachressource der Demokratie (CLARIN / BMBF)
  - MigTex - Textressourcen für die Migrations- und Integrationsforschung (BMFSFJ)
  - Die populistische Herausforderung im Parlament (DFG)


## Das MigParl-Korpus

- Entstehungshintergrund: MigTex-Projekt

- Aktuelle Gesamtaufbereitung der Plenardebatten der Länder mit *frappp*-Paket

- Bildung thematischer Subkorpora mit unüberwachtem Lernverfahren (Topic-Modelling)

- Gesamtumfang des MigParl-Korpus: `r size("MIGPARL")` Token

- Umfang ohne Zwischenrufe und Wortbeiträge des Parlamentspräsidiums: `r size("MIGPARL") - size(partition("MIGPARL", interjection = TRUE)) - size(partition("MIGPARL", role = "presidency"))`

- Strukturelle Annotation: `r paste(s_attributes("MIGPARL"), collapse = " | ")`


## MigParl - Token pro Jahr {.flexbox .vcenter}

```{r token_by_year, echo = FALSE, message = FALSE}
size_year <- size("MIGPARL", "year")
barplot(
  height = size_year[["size"]] / 100000,
  names.arg = size_year[["year"]],
  ylab = "Zahl der Worte (in Hunderttausend)",
  xlab = "Jahr",
  las = 2
)
```


## MigParl - Token der AfD {.flexbox .vcenter}

```{r token_afd, echo = FALSE, message = FALSE}
afd <- partition("MIGPARL", party = "AfD", interjection = FALSE)
afd_year <- size(afd, "year")
barplot(
  height = afd_year[["size"]] / 100000,
  names.arg = afd_year[["year"]],
  ylab = "Zahl der Worte (in Hunderttausend)",
  xlab = "Jahr",
  las = 2
)
```


## MigParl - Anteil AfD {.flexbox .vcenter}

```{r share_afd, echo = FALSE, message = FALSE}
all_year <- size("MIGPARL", s_attribute = "year")[, "what" := "all"]
afd <- partition("MIGPARL", party = "AfD", interjection = FALSE)
afd_year <- size(afd, "year")[, "what" := "AfD"]
dt <- rbindlist(list(all_year, afd_year))
dt_share <- dcast(data = dt, year ~ what, value.var = "size")
dt_share[, "year" := as.integer(year)]
dt_share[, "AfD" := ifelse(is.na(AfD), 0, AfD)]
dt_share[, "afd_share" := round((AfD / all) * 100, 2)]
dt_share_min <- dt_share[year > 2010]
barplot(
  height = dt_share_min[["afd_share"]],
  names.arg = dt_share_min[["year"]],
  ylab = "Anteil AfD",
  xlab = "Jahr",
  las = 2,
  col = "steelblue"
)
```


## MigParl - geographische Verteilung {.flexbox .vcenter}

```{r afd_geography, message = FALSE, echo = FALSE}
afd <- partition("MIGPARL", party = "AfD", interjection = FALSE)
dt <- size(afd, s_attribute = "regional_state")
setorderv(dt, cols = "size", order = -1L)
barplot(
  height = dt$size,
  names.arg = dt$regional_state,
  las = 2,
  col = "steelblue"
)
```


## Term-Extraktion I {.smaller}

```{r features, message = FALSE, echo = FALSE, render = knit_print, warning = FALSE}
afd_count <- partition("MIGPARL", party = "AfD", interjection = FALSE) %>%
  count(p_attribute = c("word", "pos"))
all_count <- partition("MIGPARL", interjection = FALSE) %>%
  count(p_attribute = c("word", "pos"))
a <- features(x = afd_count, y = all_count, included = TRUE) %>%
  subset(count_coi >= 5) %>%
  subset(chisquare >= 11.83)
a
```


## Term-Extraktion II: N-Gramme {.smaller}

```{r ngrams_ART-NN, eval = TRUE, message = FALSE, echo = FALSE, render = knit_print, warning = FALSE}
afd_ngrams <- partition("MIGPARL", party = "AfD", interjection = FALSE) %>%
  ngrams(n = 2, c("word", "pos"))
all_ngrams <- partition("MIGPARL", interjection = FALSE) %>%
  ngrams(n = 2, p_attribute = c("word", "pos"))

a <- features(x = afd_ngrams, y = all_ngrams, included = TRUE) %>%
  subset(count_coi >= 5) %>%
  subset(chisquare >= 11.83)

b <- subset(a, a@stat[["1_pos"]] == "ADJA")
b <- subset(b, b@stat[["2_pos"]] == "NN")
b <- subset(b, !b@stat[["2_word"]] %in% c("Kollegen", "Damen", "Präsidium", "Herr", "Besucher", "Abgeordnete", "Frau", "Gäste", "Zuschauer"))
b <- subset(b, !b@stat[["1_word"]] == "``")
b <- subset(b, !b@stat[["2_word"]] == "``")
dt <- b@stat[, "1_pos" := NULL][, "2_pos" := NULL][, "exp_coi" := NULL][, "rank_chisquare" := NULL]
dt[, "chisquare" := round(chisquare, 2)]
DT::datatable(dt)
```


## Term-Extraktion III: NN-ART-NN {.smaller}

```{r ngrams_nn-art-nn, eval = TRUE, message = FALSE, echo = FALSE, render = knit_print, warning = FALSE}
afd_ngrams <- partition("MIGPARL", party = "AfD", interjection = FALSE) %>%
  ngrams(n = 3, c("word", "pos"))
all_ngrams <- partition("MIGPARL", interjection = FALSE) %>%
  ngrams(n = 3, p_attribute = c("word", "pos"))

a <- features(x = afd_ngrams, y = all_ngrams, included = TRUE) %>%
  subset(count_coi >= 5) %>%
  subset(chisquare >= 11.83)

b <- subset(a, a@stat[["1_pos"]] == "NN")
b <- subset(b, b@stat[["2_pos"]] == "ART")
b <- subset(b, b@stat[["3_pos"]] == "NN")
b <- subset(b, !b@stat[["1_word"]] == "%")

b@stat[, "1_pos" := NULL][, "2_pos" := NULL][, "3_pos" := NULL][, "rank_chisquare" := NULL]
b@stat[, "chisquare" := round(chisquare, 2)]
b@stat[, "exp_coi" := round(exp_coi, 2)]
DT::datatable(b@stat)
```


## Kookkurrenz-Analyse {.smaller}

```{r migparl_noise, message = FALSE, echo = FALSE, eval = TRUE}
big_stopwords <- paste(
  toupper(substr(tm::stopwords("de"), 1,1)),
  substr(tm::stopwords("de"), 2, length(tm::stopwords("de"))),
  sep = ""
)

migparl_noise <- terms("MIGPARL", p_attribute = "word") %>%
  noise() %>%
  unlist() %>%
  c(big_stopwords, "dass") %>%
  unique()
```


```{r afd_cooccurrences, message = FALSE, echo = FALSE, eval = TRUE}
afd_rds_file <- "/Users/blaette/Nextcloud/Org/Termine/2018-12-04_Erlangen/afd_cooc.rds"
if (!file.exists(afd_rds_file)){
  afd_cooc <- partition("MIGPARL", party = "AfD", interjection = FALSE) %>%
  Cooccurrences(left = 10L, right = 10L, p_attribute = "word", stoplist = migparl_noise, verbose = TRUE, progress = TRUE) %>%
  ll() %>%
  decode()
  afd_cooc <- subset(afd_cooc, ab_count >= 5) %>% subset(ll >= 11.83)
  saveRDS(object = afd_cooc, file = afd_rds_file)
} else {
  afd_cooc <- readRDS(afd_rds_file)
}
```



```{r ref_cooccurrences, echo = FALSE, message = FALSE}
rds_file <- "/Users/blaette/Nextcloud/Org/Termine/2018-12-04_Erlangen/afd_cooc_features.rds"

if (!file.exists(rds_file)){
  all_cooc <- partition("MIGPARL", interjection = FALSE) %>%
    Cooccurrences(left = 10L, right = 10L, p_attribute = "word", stoplist = migparl_noise, verbose = TRUE) %>%
    ll() %>%
    subset(ll >= 10.83) %>%
    subset(ab_count >= 5) %>%
    decode()
  
  afd_features <- features(afd_cooc, all_cooc, included = TRUE)
  afd_features <- afd_features[1:2500]
  saveRDS(object = afd_features, file= rds_file)
} else {
  afd_features <- readRDS(file = rds_file)
}
```

```{r cooc_all, echo = FALSE, message = FALSE, render = knit_print}  
afd_min <- subset(afd_cooc, by = afd_features[1:150])
dt <- copy(afd_min@stat)
dt[, "a_id" := NULL][, "b_id" := NULL][, "size_window" := NULL]
dt[, "i.exp_coi" := NULL][, "i.exp_ref" := NULL][, "i.ll" := NULL][, "i.rank_ll" := NULL]
dt[, "rank_ll" := NULL][, "exp_ref" := NULL]
dt[, "ll" := round(ll, 2)]
dt[, "count_coi" := NULL][, "count_ref" := NULL][, "exp_coi" := NULL]
setcolorder(x = dt, neworder = c("a_word", "b_word", "ab_count", "a_count", "b_count", "ll"))
setorderv(dt, cols = "ll", order = -1L)
DT::datatable(dt)
```  



## Graph-Visualisierung (2D, N = 100) {.smaller}

```{r, echo = FALSE, message = FALSE, warning = FALSE}
make_igraph <- function(n){
  G <- subset(afd_cooc, by = afd_features[1:n]) %>%
    as_igraph() %>%
    igraph_add_coordinates(layout = "kamada.kawai", dim = 2) %>%
    igraph_add_communities() %>% 
    rescale(-250, 250)
  
  ll <- unlist(sapply(E(G)$ll, function(x) x[1]))
  G <- igraph::delete_edge_attr(G, name = "ll")
  E(G)$ll <- ll
  G
}
```

```{r, eval = TRUE, echo = FALSE, message = FALSE, warning = FALSE}
make_igraph(150) %>% gradget::as.dgr_graph() %>% render_graph()
```


## Graph-Visualisierung (2D, N = 250) {.smaller}

```{r, echo = FALSE, message = FALSE, warning = FALSE}
make_igraph(250) %>% gradget::as.dgr_graph() %>% render_graph()
```


## Graph-Visualisierung (2D, N = 400) {.smaller}

```{r, echo = FALSE, message = FALSE, warning = FALSE}
make_igraph(400) %>% gradget::as.dgr_graph() %>% render_graph()
```


## Zwischenfazit

- Anfälligkeit des Layouts von Graphen für Filter-Entscheidungen

- Grenzen der Begründbarkeit von Filter-Entscheidungen

- Potenziale der Visualisierung von Zusatzinformationen, aber Gefahr der Überfrachtung

- Überbordende Komplexität komplexer Graphen

- Wie kann die Komplexität von Graphen besser gehandhabt werden?


## 3D-Visualisierung als Lösung? {.smaller}

```{r, eval = TRUE, echo = FALSE, }
widget_1_file <- "/Users/blaette/Nextcloud/Org/Termine/2018-12-04_Erlangen/widget_1.html"
if (!file.exists(widget_1_file)){
  afd <- partition("MIGPARL", party = "AfD", interjection = FALSE)
  
  gr_dat <- subset(afd_cooc, by = afd_features[1:400]) %>%
    as_igraph() %>%
    igraph_add_coordinates(layout = "kamada.kawai", dim = 3) %>%
    igraph_add_communities() %>% 
    rescale(-250, 250) %>%
    igraph_add_kwic(subcorpus = afd) %>%
    igraph_as_gradget_data()
  
  widget <- gradget(gr_dat, anaglyph = FALSE)
  
  htmlwidgets::saveWidget(widget = widget, file = widget_1_file)
}
```

<iframe title="Koehler" width="100%"  src="./widget_1.html" frameborder="0" scrolling="no" onload="resizeIframe(this)" padding="0em !important" margin-left="0 !important"></iframe>


## Anaglyph-Darstellung als Lösung? {.smaller}

```{r, eval = TRUE, echo = FALSE, message = FALSE}
widget_2_file <- "/Users/blaette/Nextcloud/Org/Termine/2018-12-04_Erlangen/widget_2.html"
if (!file.exists(widget_2_file)){
  afd <- partition("MIGPARL", party = "AfD", interjection = FALSE)
  
  gr_dat <- subset(afd_cooc, by = afd_features[1:400]) %>%
    as_igraph() %>%
    igraph_add_coordinates(layout = "kamada.kawai", dim = 3) %>%
    igraph_add_communities() %>% 
    rescale(-250, 250) %>%
    igraph_add_kwic(subcorpus = afd) %>%
    igraph_as_gradget_data()
  
  widget <- gradget(gr_dat, anaglyph = TRUE)
  
  htmlwidgets::saveWidget(widget = widget, file = widget_2_file)
}
```

<iframe title="Koehler" width="100%"  src="./widget_2.html" frameborder="0" scrolling="no" onload="resizeIframe(this)" padding="0em !important" margin-left="0 !important"></iframe>


## Stärkere Filter {.smaller}

```{r, echo = FALSE, message = FALSE}
widget_3_file <- "/Users/blaette/Nextcloud/Org/Termine/2018-12-04_Erlangen/widget_3.html"

if (!file.exists(widget_3_file)){
  afd_cooc <- readRDS("/Users/blaette/Nextcloud/Org/Termine/2018-12-04_Erlangen/afd_cooc.rds")
  afd_features <- readRDS("/Users/blaette/Nextcloud/Org/Termine/2018-12-04_Erlangen/afd_cooc_features.rds")
  
  g <- subset(afd_cooc, by = afd_features[1:400]) %>%
    as_igraph() %>%
    simplify()
  
  bs <- g %>% cohesive_blocks() %>% blocks()
  
  g_min <- induced_subgraph(g, v = bs[[order(sapply(bs, length), decreasing = TRUE)[2]]])
  
  g_min_fin <- g_min %>%
    igraph_add_coordinates(layout = "kamada.kawai", dim = 3) %>%
    igraph_add_communities() %>% 
    rescale(-250, 250) %>%
    igraph_add_kwic(subcorpus = partition("MIGPARL", party = "AfD", interjection = FALSE))
  
  
  widget <- igraph_as_gradget_data(g_min_fin) %>%
    gradget(anaglyph = TRUE)
  
  htmlwidgets::saveWidget(widget = widget, file = widget_3_file)
}
```

<iframe title="Koehler" width="100%"  src="./widget_3.html" frameborder="0" scrolling="no" onload="resizeIframe(this)" padding="0em !important" margin-left="0 !important"></iframe>


## Schlussfolgerungen {.build}

- AfD als Partei der Höflichkeit (?)

- AfD-Autismus? Interaktion der AfD mit anderen Fraktionen (und Besuchern!)

- Konstruktion von Gegensätzen: Wir (AfD / AfD-Fraktion) und die anderen

- redistributive Logik als Leitmotiv (Bezifferung von Kosten)

- "visuelle Hermeneutik" (G. Schaal) - Graph-Annotation als neue Kombination quantitativer und qualitativer Textanalyse
